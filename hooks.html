<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7 at 22 June 2016 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="The MyBatis Team" />
    <meta name="Date-Revision-yyyymmdd" content="20160622" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MyBatis Migrations &#x2013; MyBatis Migrations | Migration hooks</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>MyBatis Migrations</h2>
                </div>
                      </div>
        <div class="pull-right">                                <a href="../" id="bannerRight" title="MyBatis logo">
                                                                                        <img src="http://mybatis.github.io/images/mybatis-logo.png"  alt="MyBatis logo"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 22 June 2016
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 3.3.0-SNAPSHOT
                      </li>
                      
              
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Migrations</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <span class="none"></span>
        Introduction</a>
            </li>
                
      <li>
  
                          <a href="installation.html" title="Installation">
          <span class="none"></span>
        Installation</a>
            </li>
                                                                                                                                                                                                            
      <li>
  
                          <a href="migrate.html" title="The 'migrate' Command">
          <span class="icon-chevron-down"></span>
        The 'migrate' Command</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="init.html" title="init">
          <span class="none"></span>
        init</a>
            </li>
                    
      <li>
  
                          <a href="bootstrap.html" title="bootstrap">
          <span class="none"></span>
        bootstrap</a>
            </li>
                    
      <li>
  
                          <a href="new.html" title="new">
          <span class="none"></span>
        new</a>
            </li>
                    
      <li>
  
                          <a href="status.html" title="status">
          <span class="none"></span>
        status</a>
            </li>
                    
      <li>
  
                          <a href="updown.html" title="up, down">
          <span class="none"></span>
        up, down</a>
            </li>
                    
      <li>
  
                          <a href="version.html" title="version">
          <span class="none"></span>
        version</a>
            </li>
                    
      <li>
  
                          <a href="pending.html" title="pending">
          <span class="none"></span>
        pending</a>
            </li>
                    
      <li>
  
                          <a href="script.html" title="script">
          <span class="none"></span>
        script</a>
            </li>
                    
      <li>
  
                          <a href="shortcuts.html" title="Command Shortcuts">
          <span class="none"></span>
        Command Shortcuts</a>
            </li>
              </ul>
        </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>Migration Hooks</a>
          </li>
                
      <li>
  
                          <a href="runtime-migration.html" title="Runtime Schema Migration">
          <span class="none"></span>
        Runtime Schema Migration</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                        
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                        
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            

  

    <div class="section">
<h2><a name="Migration_Hooks"></a>Migration Hooks</h2>

      
<p>
        Since 3.3.0, MyBatis Migrations supports pre/post-migration hooks.
      </p>

      
<div class="section">
<h3><a name="Overview"></a>Overview</h3>

        
<p>
          You can write scripts that are executed before or after up/down operation.<br />
          The following hooks are supported.
        </p>

        
<ul>
          
<li>before up/down : executed before the first migration</li>
          
<li>before each up/down : executed before each migration</li>
          
<li>after each up/down : executed after each migration</li>
          
<li>after up/down : executed after the last migration</li>
        </ul>

        
<p>
          Hook scripts can be written in <b>SQL</b> or <b>JSR-223</b> compliannt script languages.
        </p>

      </div>

      
<div class="section">
<h3><a name="Quick_start"></a>Quick start</h3>

        
<p>
          Here is what you need to do to use hook scripts.
        </p>

        
<ol style="list-style-type: decimal">
          
<li>Create <i>hooks</i> directory.</li>
          
<li>Create a hook script in <i>hooks</i> directory.</li>
          
<li>Add a setting to the environment properties file.</li>
        </ol>

        
<div class="section">
<h4><a name="a1._Create_hooks_directory."></a>1. Create <i>hooks</i> directory.</h4>

        
<p>
          Create a directory named <i>hooks</i> in the base directory.
        </p>

        </div>
<div class="section">
<h4><a name="a2._Create_a_hook_script_in_hooks_directory."></a>2. Create a hook script in <i>hooks</i> directory.</h4>

        
<p>
          The following script outputs the famous string to the log.<br />
          Save this script in the <i>hooks</i> directory as <i>hello.js</i>.
        </p>

        
<div class="source"><pre class="prettyprint">print('Hello, World!');</pre></div>

        </div>
<div class="section">
<h4><a name="a3._Add_a_setting_to_the_environment_properties_file."></a>3. Add a setting to the environment properties file.</h4>

        
<p>
          To configure Migrations, add the following line to the <i>development.properties</i> in the <i>environments</i> directory.
        </p>

        
<div class="source"><pre class="prettyprint">hook_before_up=JavaScript:hello.js</pre></div>

        
<p>
          The details will be explained in the later section, but the above line tells Migrations to execute <i>hello.js</i> at the beginning of <tt>migrate up</tt> operation.
        </p>

        
<p>
          Now, if you run <tt>migrate up</tt>, you will find the following lines in the log.
        </p>

        
<div class="source"><pre class="prettyprint">========== Applying JSR-223 hook : hello.js ==========
Hello, World!</pre></div>

        
<p>
          <span class="label important">NOTE</span>
          The hook script will not be executed if there was no pending migration.
        </p>

      </div></div>

      
<div class="section">
<h3><a name="Configuration"></a>Configuration</h3>

        
<p>
          As shown in the Quick Start section, migration hook is configured by adding a line in the environment properties file in <tt>key=value</tt> format.<br />
        </p>

        
<div class="section">
<h4><a name="Keys_for_available_hooks"></a>Keys for available hooks</h4>

        
<p>
          Here is the list of available hooks.
        </p>

        
<ul>
          
<li>hook_before_up</li>
          
<li>hook_before_each_up</li>
          
<li>hook_after_each_up</li>
          
<li>hook_after_up</li>
          
<li>hook_before_down</li>
          
<li>hook_before_each_down</li>
          
<li>hook_after_each_down</li>
          
<li>hook_after_down</li>
        </ul>

        </div>
<div class="section">
<h4><a name="Minimum_setting_:_language_and_file_name"></a>Minimum setting : language and file name</h4>

        
<p>
          The value part of the setting line consists of two or more segments separated with a colon <tt>:</tt>.<br />
          The first segment is the language name (e.g. <tt>SQL</tt>, <tt>JavaScript</tt>, <tt>Groovy</tt>, etc.). The second segment is the file name. These two segments are required.
          Here are some examples:
        </p>

        
<div class="source"><pre class="prettyprint">hook_before_up=SQL:insert_log.sql
hook_after_up=JavaScript:RestartServer.js</pre></div>

      </div></div>

      
<div class="section">
<h3><a name="Constant_variables"></a>Constant variables</h3>

        
<p>
          The other segments are used to define constant variables specific to this particular hook script. These variables can have arbitrary names, but there also are some special variable names for JSR-223 hooks that are explained in the later section.
        </p>

        
<p>
          The following settings reference the same hook script <i>printvar.js</i> with different variable values.
        </p>

        
<div class="source"><pre class="prettyprint">// development.properties
hook_before_up=JavaScript:printvar.js:when=before:what=up
hook_after_down=JavaScript:printvar.js:when=after:what=down</pre></div>

        
<p>
          Constant variables can be referenced as global variables in JavaScript.
        </p>

        
<div class="source"><pre class="prettyprint">// printvar.js
print('This is ' + when + ' ' + what + ' hook.');</pre></div>

        
<p>
          The above script will print <tt>This is before up hook.</tt> on <tt>migrate up</tt> and <tt>This is after down hook.</tt> on <tt>migrate down</tt>.
        </p>

        
<p>
          Also, if there are global variables defined in the environment properties file, they can be used in hook scripts in the same manner.
        </p>

        
<div class="source"><pre class="prettyprint">// development.properties
foo=bar</pre></div>

        
<p>
          These variables can be used in SQL hook scripts as well.
        </p>

        
<div class="source"><pre class="prettyprint"># development.properties
hook_before_up=SQL:update_timestamp.sql:col=before
hook_after_up=SQL:update_timestamp.sql:col=after</pre></div>
        
<div class="source"><pre class="prettyprint">// update_timestamp.sql
update worklog set ${col} = current_date();</pre></div>

      </div>

      
<div class="section">
<h3><a name="Advanced_usage_of_JSR-223_scripts"></a>Advanced usage of JSR-223 scripts</h3>

        
<div class="section">
<h4><a name="Get_paths_to_the_directories"></a>Get paths to the directories</h4>

        
<p>
          An instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/options/SelectedPaths.html" target="_blank">SelectedPaths</a> object is accessible as a global variable <tt>migrationPaths</tt>.
        </p>

        
<div class="source"><pre class="prettyprint">print(migrationPaths.getBasePath());
print(migrationPaths.getEnvPath());
print(migrationPaths.getScriptPath());
print(migrationPaths.getDriverPath());
print(migrationPaths.getHookPath());</pre></div>

        </div>
<div class="section">
<h4><a name="Accessing_Change_object_in_each_hook_only"></a>Accessing <i>Change</i> object (in each hook only)</h4>

        
<p>
          In an each hook script, an instance of <a href="/migrations/apidocs/org/apache/ibatis/migration/Change.html" target="_blank">Change</a> object is accessible via the global variable <tt>migrationContext</tt>.
        </p>

        
<div class="source"><pre class="prettyprint">print(migrationContext.getChange().getId());
print(migrationContext.getChange().getFilename());</pre></div>

        
<p>
          <span class="label important">NOTE</span>
          The Change instance is a clone and will be discarded after each exection, so modifying it would be meaningless.
        </p>

        </div>
<div class="section">
<h4><a name="Execute_SQL_statement"></a>Execute SQL statement</h4>

        
<p>
          You can execute arbitrary SQL statement via the built-in global object <tt>migrationContext</tt>.
        </p>

        
<div class="source"><pre class="prettyprint">migrationContext.executeSql(&quot;insert into worklog (str1) values ('done!');&quot;);</pre></div>

        
<p>
          If you need more than just executing SQL statement, you can get an instance of <tt>java.sql.Connection</tt> from <tt>migrationContext</tt>.
        </p>

        
<div class="source"><pre class="prettyprint">con = migrationContext.getConnection();
try {
  stmt = con.createStatement();
  rs = stmt.executeQuery(&quot;select * from changelog&quot;);
  while (rs.next()) {
    print(&quot;id = &quot; + rs.getString(&quot;id&quot;));
  }
} finally {
  con.close();
  con = null;
  rs = null;
  stmt = null;
}</pre></div>


        </div>
<div class="section">
<h4><a name="Invoking_function"></a>Invoking function</h4>

        
<p>
          When configuring JSR-223 hook scripts, it is possible to specify a top level function to invoke. The following script contains two functions <tt>foo</tt> and <tt>bar</tt> and <tt>bar</tt> takes two arguments.
        </p>

        
<div class="source"><pre class="prettyprint">// foobar.js
function foo() {
  print('foo');
}

function bar(id, name) {
  print(id + ':' + name);
}</pre></div>

        
<p>
          To invoke these function, specify the function name using a special variable name <tt>_function</tt> and parameter values with <tt>_arg</tt>.
        </p>

        
<div class="source"><pre class="prettyprint">hook_before_up=js:foobar.js:_function=foo
hook_after_up=js:foobar.js:_function=bar:_arg=100:_arg=John</pre></div>

        
<p>
          <span class="label important">NOTE</span>
          Some JSR-223 implementation may not support function invocation.
        </p>

        </div>
<div class="section">
<h4><a name="Invoking_method"></a>Invoking method</h4>

        
<p>
          Similar to function invocation, it is also possible to invoke a method of an top level object.
        </p>

        
<div class="source"><pre class="prettyprint">// doggy.js
var dog = new Object();
dog.bark = function(who, times) {
  print('bow-wow ' + times + ' times at ' + who);
});</pre></div>

        
<p>
          In the hook setting, use <tt>_object</tt> to specify the object name and <tt>_method</tt> to specify the method name.
        </p>

        
<div class="source"><pre class="prettyprint">hook_before_up=js:doggy.js:_object=dog:_method=bark:_arg=Lucy:_arg=128</pre></div>

        
<p>
          <span class="label important">NOTE</span>
          Some JSR-223 implementation may not support method invocation.
        </p>

        </div>
<div class="section">
<h4><a name="Retain_variable_value_throughout_the_operation"></a>Retain variable value throughout the operation</h4>

        
<p>
          When single up/down operation executes multiple migrations, variables are reset on each migration.<br />
          There are two ways to retain variable value throughout the operation.
        </p>

        
<ol style="list-style-type: decimal">
          
<li>
            Initialize the variable in before_up/down script and use it in before/after_each_up/down script.
            
<div class="source"><pre class="prettyprint">// before_up hook script
var counter = 1;</pre></div>
            
<div class="source"><pre class="prettyprint">// before_each_up hook script
print(counter++);</pre></div>
          </li>
          
<li>
            Initialize only when the variable is <i>undefined</i>.
            
<div class="source"><pre class="prettyprint">if (typeof counter == 'undefined') this.counter = 1;
println(counter++);</pre></div>
          </li>
        </ol>

        </div>
<div class="section">
<h4><a name="Use_other_languages_than_JavaScript"></a>Use other languages than JavaScript</h4>

        
<p>
          To use other JSR-223 compliant scripting language than JavaScript, you need to copy required .jar files to <i>$MIGRATIONS_HOME/lib</i> directory.
        </p>

        
<p>
          To write hook scripts in <a class="externalLink" href="http://groovy-lang.org" target="_blank">Groovy</a>, for example, you will need <a class="externalLink" href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy" target="_blank">groovy.jar</a> and <a class="externalLink" href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy-jsr223" target="_blank">groovy-jsr223.jar</a>.<br />
          Once the JARs are placed in <i>$MIGRATIONS_HOME/lib</i> directory, the rest is pretty much the same as JavaScript.<br />
          Save the following script as <tt>hello.groovy</tt> in <i>hooks</i> directory with the following content...
        </p>

        
<div class="source"><pre class="prettyprint">println('Hello groovy!')</pre></div>

        
<p>...and add the setting to the environment properties file.</p>

        
<div class="source"><pre class="prettyprint">hook_before_up=groovy:hello.groovy</pre></div>

      </div></div>

    </div>

  


                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2010&#x2013;2016
                        <a href="http://www.mybatis.org/">MyBatis.org</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
